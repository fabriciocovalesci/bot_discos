<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot de Discos - Controle</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <div class="container">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="btn btn-danger" href="/logout">Sair</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h2 class="mb-4 text-center">üé∂ Controle do Bot de Discos üé∂</h2>


        <div class="card mb-4">
            <div class="card-header">‚è∞ Configura√ß√£o do Cron</div>
            <div class="card-body">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#datetimeModal">Configurar Cron</button>
                <p id="cronMessage" class="mt-3"></p> 
            </div>
        </div>


        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">üì• Palavras para busca no Mercado Livre</div>
                    <div class="card-body">
                        <ul id="inputList" class="list-group"></ul>
                        <input type="text" id="newInput" class="form-control mt-2" placeholder="Adicionar novo termo">
                        <button class="btn btn-success mt-2" onclick="addInput()">‚ûï Adicionar</button>
                    </div>
                </div>
            </div>


            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">üö´ Palavras Proibidas</div>
                    <div class="card-body">
                        <ul id="proibidosList" class="list-group"></ul>
                        <input type="text" id="newProibido" class="form-control mt-2" placeholder="Adicionar termo proibido">
                        <button class="btn btn-danger mt-2" onclick="addProibido()">‚ûï Adicionar</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">üìÇ Resultados de Busca</div>
            <div class="card-body">
                <ul id="resultadosList" class="list-group">
                </ul>
            </div>
        </div>
        
    </div>


    <div class="modal fade" id="datetimeModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">Configurar Hor√°rio do Cron</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label for="cronHour">Selecione a hora:</label>
                    <select id="cronHour" class="form-select mb-3">
                        <option value="*">Todos</option>
                        <script>
                            for (let h = 0; h < 24; h++) {
                                let hour = h.toString().padStart(2, '0');
                                document.write(`<option value="${hour}">${hour}:00</option>`);
                            }
                        </script>
                    </select>
    
                    <label>Selecione os minutos:</label>
                    <div class="d-flex flex-wrap gap-2" id="minuteContainer">
                        <button type="button" class="btn btn-outline-danger minute-btn" data-minute="*">Todos</button>
                        <script>
                            for (let m = 5; m < 60; m += 5) {  // Inicia a partir de 5 minutos
                                let minute = m.toString().padStart(2, '0');
                                document.write(`
                                    <button type="button" class="btn btn-outline-primary minute-btn" data-minute="${minute}">
                                        ${minute} min
                                    </button>
                                `);
                            }
                        </script>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="setCronJob()" id="saveCron">Salvar</button>
                </div>
            </div>
        </div>
    </div>


    <script>

        async function loadData() {

        const cron = await axios.get('/set-cron');
        if(cron.data && cron.data.cron){
            let times = cron.data.cron[0].split(":")
            if (times[0] === "*"){
                document.getElementById("cronMessage").innerText = `O cron ser√° executado a cada ${times[1]} minutos.`;
            }else {
                document.getElementById("cronMessage").innerText = `O cron ser√° executado a cada ${times[0]}h:${times[1]} minutos.`;
            }
        }


        const resultados = await axios.get('/resultados');
        const resultadosList = document.getElementById("resultadosList");
        resultadosList.innerHTML = "";
        

        if (resultados.data && resultados.data.resultados) {
            resultados.data.resultados.forEach(file => {
                const li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between align-items-center";
            
                const span = document.createElement("span");
                span.textContent = file;

                const downloadBtn = document.createElement("button");
                downloadBtn.className = "btn btn-sm btn-primary";
                downloadBtn.textContent = "üì• Baixar";
                downloadBtn.onclick = () => downloadFile(file);
                
                li.appendChild(span);
                li.appendChild(downloadBtn);
                resultadosList.appendChild(li);
            });
        } else {
            resultadosList.innerHTML = "<li class='list-group-item'>Nenhum resultado encontrado</li>";
        }


            const inputRes = await axios.get('/input');
            document.getElementById("inputList").innerHTML = inputRes.data.input.map(item =>
                `<li class="list-group-item d-flex justify-content-between">${item} 
                    <button class="btn btn-sm btn-danger" onclick="removeInput('${item}')">‚ùå</button>
                </li>`
            ).join('');

            const proibidosRes = await axios.get('/proibidos');
            const proibidosList = document.getElementById("proibidosList");
            proibidosList.innerHTML = "";

            proibidosRes.data.proibidos.forEach(item => {
                const li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between align-items-center";

                const span = document.createElement("span");
                span.textContent = item;

                const btn = document.createElement("button");
                btn.className = "btn btn-sm btn-danger";
                btn.innerHTML = "‚ùå";
                btn.onclick = () => removeProibido(item);

                li.appendChild(span);
                li.appendChild(btn);
                proibidosList.appendChild(li);
            });
        }

        function downloadFile(file) {
            window.location.href = `/download/${file}`;
        }


        async function runSearch() {
            const query = document.getElementById("searchQuery").value;
            if (!query) return alert("Digite um termo para buscar!");
            await axios.post('/run', { query });
            alert(`Busca iniciada para "${query}"!`);
        }

        async function addInput() {
            const name = document.getElementById("newInput").value;
            if (!name) return;
            await axios.post('/input', { name });
            loadData();
            document.getElementById("newInput").value = ""
            
        }

        async function removeInput(name) {
            await axios.delete('/input', { data: { name } });
            loadData();
            document.getElementById("newProibido").value = "";
        }

        async function addProibido() {
            const input = document.getElementById("newProibido").value;
            if (!input) return;
            await axios.post('/proibidos', { name: input });
            loadData();
            document.getElementById("newProibido").value = "";
        }

        async function removeProibido(name) {
            await axios.delete('/proibidos', { data: { name } });
            loadData();
        }


        let selectedMinute = null;

        function updateCronMessage() {
            let hour = document.getElementById("cronHour").value;

            if (selectedMinute === null) {
                document.getElementById("cronMessage").innerText = "Por favor, selecione o hor√°rio do cron.";
            } else if (selectedMinute !== "*" && hour === "*") {
                document.getElementById("cronMessage").innerText = `O cron ser√° executado a cada ${selectedMinute} minutos.`;
            }
        }


        document.querySelectorAll('.minute-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                let minuteValue = this.getAttribute('data-minute');

                if (minuteValue === "*") {
                    selectedMinute = "*";
                    document.querySelectorAll('.minute-btn').forEach(b => {
                        b.classList.remove('btn-primary', 'btn-danger');
                        b.classList.add('btn-outline-primary');
                    });
                    this.classList.remove('btn-outline-danger');
                    this.classList.add('btn-danger');
                } else {
                    document.querySelector('.minute-btn[data-minute="*"]').classList.remove('btn-danger');
                    document.querySelector('.minute-btn[data-minute="*"]').classList.add('btn-outline-danger');
                    selectedMinute = minuteValue;

                    document.querySelectorAll('.minute-btn').forEach(b => {
                        if (b.getAttribute('data-minute') !== "*") {
                            b.classList.remove('btn-primary');
                            b.classList.add('btn-outline-primary');
                        }
                    });

                    this.classList.remove('btn-outline-primary');
                    this.classList.add('btn-primary');
                }

                updateCronMessage();
            });
        });

        async function setCronJob() {
            let hour = document.getElementById("cronHour").value;
            let cronTime = `${hour}:${selectedMinute}`;
            try {
                await axios.post('/set-cron', { time: cronTime });
                alert("Cron configurado com sucesso para: " + cronTime);
            } catch (error) {
                alert("Erro ao configurar o cron!");
                console.error(error);
            }
        }

        document.getElementById("saveCron").addEventListener("click", function() {
            document.getElementById("saveCron").style.color = 'white';
            const modal = bootstrap.Modal.getInstance(document.getElementById('datetimeModal'));
            modal.hide();
        });



        loadData();

        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

</body>
</html> 
